<ion-modal [isOpen]="isOpen" (didDismiss)="setOpen.emit(false)" [initialBreakpoint]="1" [breakpoints]="[0, 1]" *ngIf="(mealService.categories$ | async) as categories">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Yeni Yemek Ekle</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="setOpen.emit(false)">Kapat</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding">
      <ng-container *ngIf="isCreatingNewMeal">
        <ion-list>
            <ion-item lines="none">
              <ion-label>
                <h2>Yeni Özel Yemek Oluştur</h2>
                <p>1 porsiyon için besin değerlerini girin.</p>
              </ion-label>

              <ion-button slot="end" fill="clear" (click)="toggleCreateNewMealView(false)">
                  Vazgeç
              </ion-button>
          </ion-item>

          <ion-item>
              <ion-input label="Yemek Adı" label-placement="floating" [(ngModel)]="newCustomMeal.name" required></ion-input>
          </ion-item>

          <ion-item>
              <ion-input label="Pürin (mg / porsiyon)" label-placement="floating" type="number" [(ngModel)]="newCustomMeal.purine" required></ion-input>
          </ion-item>
            <ion-item>
              <ion-input label="Şeker (g / porsiyon)" label-placement="floating" type="number" [(ngModel)]="newCustomMeal.sugar" required></ion-input>
          </ion-item>
          <ion-item>
              <ion-input label="Kalori (kcal / porsiyon)" label-placement="floating" type="number" [(ngModel)]="newCustomMeal.kcal" required></ion-input>
          </ion-item>
          <ion-button expand="block" (click)="createAndSelectCustomMeal()" class="ion-margin-top">
              Oluştur ve Seç
          </ion-button>
      </ion-list>
      </ng-container>

      <ng-container *ngIf="!isCreatingNewMeal">
        <ion-list>
          <ion-item>
            <ion-input #searchInput placeholder="Yemek ara" (ionInput)="handleSearch($event)" [(ngModel)]="searchQuery"></ion-input>
            <ion-button slot="end" fill="clear" (click)="toggleCreateNewMealView(true)" title="Yeni özel yemek oluştur">
              <ion-icon slot="icon-only" name="add-circle-outline"></ion-icon>
            </ion-button>
          </ion-item>

          <ion-item *ngIf="searchResults.length != 0">
            <div forceOverscroll="false" class="search-results">
              <ion-list>
                <ion-item *ngFor="let meal of searchResults;" (click)="selectSearchResult(meal)">
                  <p>{{ meal.name }}</p>
                </ion-item>
              </ion-list>
            </div>
          </ion-item>
          
          <ion-item>
            <ion-select label="Kategori" placeholder="Kategori Seçin" [(ngModel)]="selectedCategory">
              <ion-select-option *ngFor="let category of getCategoryNames(categories)" [value]="category">
                {{ category }}
              </ion-select-option>
            </ion-select>
          </ion-item>

          <!--<ion-item *ngIf="selectedCategory">
            <ion-select label="Yemek" placeholder="Yemek Seçin" (ionChange)="onSelectMeal($event)"
              [value]="currentMealEntry.meal?.id">
              <ion-select-option *ngFor="let meal of filterMeals()" [value]="meal.id">
                {{ meal.name }}
              </ion-select-option>
            </ion-select>
          </ion-item>-->
        </ion-list>
      </ng-container>
      
      <ion-list>
        <ion-item>
          <ion-input label="Porsiyon" label-placement="floating" type="number" inputmode="decimal" min="1"
            [(ngModel)]="currentMealEntry.count"></ion-input>
        </ion-item>

        <ion-item *ngIf="currentMealEntry.meal">
          <p>{{ currentMealEntry.count }} porsiyon için</p>
          <ul>
            <li>Pürin: {{ currentMealEntry.count * currentMealEntry.meal.purine }} mg</li>
            <li>Şeker: {{ currentMealEntry.count * currentMealEntry.meal.sugar }} g</li>
            <li>Kalori: {{ currentMealEntry.count * currentMealEntry.meal.kcal }}</li>
          </ul>
        </ion-item>

        @let date = createDateFrom(currentMealEntry.timestamp);

        <ion-item>
          <ion-input label="Tarih" label-placement="floating" type="date" [value]="
            `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`
          " (ionChange)="onDateChange($event)"></ion-input>
        </ion-item>

        <ion-item>
          <ion-input label="Saat" label-placement="floating" type="time" [value]="
            `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`
          " (ionChange)="onTimeChange($event)"></ion-input>
        </ion-item>
      </ion-list>

      <ion-button expand="block" (click)="pushMealEntry()" class="ion-margin-top">
        <ion-icon name="add-circle-outline" slot="start"></ion-icon>
        Eklenecek Yemeklere Ekle
      </ion-button>

      <ion-card *ngIf="mealEntries.length > 0" class="ion-margin-top added-meals-card">
        <ion-card-header>
          <ion-card-title>Eklenecek Yemekler</ion-card-title>
        </ion-card-header>

        <ion-card-content>
          <ion-list lines="full">
            <ion-item *ngFor="let entry of mealEntries; let i = index">
              <ion-label>
                <h2>{{ entry.meal?.name }}</h2>
                <p>
                  {{ entry.count }} porsiyon 
                  {{ createDateFrom(entry.timestamp).toLocaleDateString('tr-TR') }}
                  {{ createDateFrom(entry.timestamp).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }) }}

                <p class="meal-details">
                  Pürin: {{(entry.meal.purine * entry.count).toFixed(0)}}mg, <br>
                  Şeker: {{(entry.meal.sugar * entry.count).toFixed(1)}}g, <br>
                  Kalori: {{(entry.meal.kcal * entry.count).toFixed(0)}}kcal
                </p>
              </ion-label>
              <ion-button fill="clear" color="danger" size="small" (click)="removeMealEntryFromList(i)">
                <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
              </ion-button>
            </ion-item>
          </ion-list>
        </ion-card-content>
      </ion-card>

      <ion-button expand="block" (click)="addMeal()" class="ion-margin-top bottom-button" [disabled]="mealEntries.length === 0">
        <ion-icon name="add-circle-outline" slot="start"></ion-icon>
        Seçilenleri Ekle
      </ion-button>
    </ion-content>
  </ng-template>
</ion-modal>
