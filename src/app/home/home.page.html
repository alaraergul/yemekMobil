<ion-content>
  <div *ngIf="authService.isLogged">
    @let user = (authService.user$ | async);

    <div *ngIf="(mealService.data$ | async) as data" class="page-container">
      @let dataByDate = getEntriesOfDate(data);

      <div class="top-bar">
        <h1 class="page-title">NutriLog</h1>
        <div class="top-bar-actions">
          <ion-button fill="clear" (click)="goSettings()" class="icon-button">
            <ion-icon slot="icon-only" name="settings-outline"></ion-icon>
          </ion-button>
          <ion-button fill="clear" (click)="logout()" class="icon-button">
            <ion-icon slot="icon-only" name="log-out-outline"></ion-icon>
          </ion-button>
        </div>
      </div>

      <ion-card class="control-panel">
        <ion-item lines="none">
          <ion-input type="date"
            [value]="getDateString(date.day, date.month + 1, date.year)"
            [max]="getDateString(today.getDate(), today.getMonth() + 1, today.getFullYear())"
            (ionChange)="onMainDateChange($event)">
          </ion-input>
        </ion-item>
      </ion-card>

      <div class="summary-grid">
        <div>
          <ion-card class="summary-card">
            @let riskOfDailyPurine = getRisk(DataType.PURINE, getTotal(DataType.PURINE, dataByDate), user, 1);

            <ion-card-header>
              <ion-card-subtitle>Günlük Toplam Pürin</ion-card-subtitle>

              <ion-card-title [style.color]="getColor(riskOfDailyPurine)">
                <ion-icon [name]="getIcon(riskOfDailyPurine)"></ion-icon>
                {{ getTotal(DataType.PURINE, dataByDate).toFixed(0) }} / {{authService.getLimits(user).purineLimit }} mg</ion-card-title>
            </ion-card-header>

            <ion-card-content>
              <p>{{ getComment(riskOfDailyPurine) }}</p>
            </ion-card-content>
          </ion-card>

          <ion-card class="summary-card">
            @let riskOfWeeklyPurine = getRisk(DataType.PURINE, getWeeklyTotal(DataType.PURINE, data), user, 7);

            <ion-card-header>
              <ion-card-subtitle>
                Bu Haftanın Toplamı
                <ion-toggle [(ngModel)]="chartModes.purine"></ion-toggle>
              </ion-card-subtitle>

              <ion-card-title [style.color]="getColor(riskOfWeeklyPurine)">
                <ion-icon [name]="getIcon(riskOfWeeklyPurine)"></ion-icon>
                {{ getWeeklyTotal(DataType.PURINE, data).toFixed(0) }} / {{authService.getLimits(user).purineLimit * 7 }} mg
              </ion-card-title>
            </ion-card-header>

            <ion-card-content>
              <p>{{ getComment(riskOfWeeklyPurine) }}</p>
            </ion-card-content>
          </ion-card>
        </div>

        <div>
          <ion-card class="summary-card">
            @let riskOfDailySugar = getRisk(DataType.SUGAR, getTotal(DataType.SUGAR, dataByDate), user, 1);

            <ion-card-header>
              <ion-card-subtitle>Günlük Toplam Şeker</ion-card-subtitle>

              <ion-card-title [style.color]="getColor(riskOfDailySugar)">
                <ion-icon [name]="getIcon(riskOfDailySugar)"></ion-icon>
                {{ getTotal(DataType.SUGAR, dataByDate).toFixed(0) }} / {{authService.getLimits(user).sugarLimit }} g
              </ion-card-title>
            </ion-card-header>

            <ion-card-content>
              <p>{{ getComment(riskOfDailySugar) }}</p>
            </ion-card-content>
          </ion-card>

          <ion-card class="summary-card">
            @let riskOfWeeklySugar = getRisk(DataType.SUGAR, getWeeklyTotal(DataType.SUGAR, data), user, 7);

            <ion-card-header>
              <ion-card-subtitle>
                Bu Haftanın Toplamı
                <ion-toggle [(ngModel)]="chartModes.sugar"></ion-toggle>
              </ion-card-subtitle>

              <ion-card-title [style.color]="getColor(riskOfWeeklySugar)">
                <ion-icon [name]="getIcon(riskOfWeeklySugar)"></ion-icon>
                {{ getWeeklyTotal(DataType.SUGAR, data).toFixed(0) }} / {{authService.getLimits(user).sugarLimit * 7 }} g
              </ion-card-title>
            </ion-card-header>

            <ion-card-content>
              <p>{{ getComment(riskOfWeeklySugar) }}</p>
            </ion-card-content>
          </ion-card>
        </div>

        <div>
          <ion-card class="summary-card">
            @let riskOfDailyKCAL = getRisk(DataType.KCAL, getTotal(DataType.KCAL, dataByDate), user, 1);

            <ion-card-header>
              <ion-card-subtitle>Günlük Toplam Kalori</ion-card-subtitle>

              <ion-card-title [style.color]="getColor(riskOfDailyKCAL)">
                <ion-icon [name]="getIcon(riskOfDailyKCAL)"></ion-icon>
                {{ getTotal(DataType.KCAL, dataByDate).toFixed(0) }} / {{ authService.getLimits(user).kcalLimit }}
              </ion-card-title>
            </ion-card-header>

            <ion-card-content>
              <p>{{ getComment(riskOfDailyKCAL) }}</p>
            </ion-card-content>
          </ion-card>

          <ion-card class="summary-card">
            @let riskOfWeeklyKCAL = getRisk(DataType.KCAL, getWeeklyTotal(DataType.KCAL, data), user, 7);

            <ion-card-header>
              <ion-card-subtitle>
                Bu Haftanın Toplamı
                <ion-toggle [(ngModel)]="chartModes.kcal"></ion-toggle>
              </ion-card-subtitle>

              <ion-card-title [style.color]="getColor(riskOfWeeklyKCAL)">
                <ion-icon [name]="getIcon(riskOfWeeklyKCAL)"></ion-icon>
                {{ getWeeklyTotal(DataType.KCAL, data).toFixed(0) }} / {{ authService.getLimits(user).kcalLimit * 7 }}
              </ion-card-title>
            </ion-card-header>

            <ion-card-content>
              <p>{{ getComment(riskOfWeeklyKCAL) }}</p>
            </ion-card-content>
          </ion-card>
        </div>
      </div>

      <div class="conditional-content">
        @if (isGraphMode) {
        <app-chart [data]="data" [date]="date" [purineMode]="chartModes.purine" [sugarMode]="chartModes.sugar" [kcalMode]="chartModes.kcal" (changeMode)="handeChangeMode($event)"></app-chart>
        } @else {
        @let weeklyData = getWeeklyNumberData(data);
        @let names = ["Pazartesi", "Salı", "Çarşamba", "Perşembe", "Cuma", "Cumartesi", "Pazar"];
        <ion-card class="summary-card weekly-summary">
          <ion-card-header>
            <ion-card-subtitle>Haftalık Pürin Dağılımı</ion-card-subtitle>
          </ion-card-header>
          <ion-card-content>
            <div class="weekly-grid">
              @let limits = authService.getLimits(user);
              <div *ngFor="let values of weeklyData; index as i" class="day-item">
                <div class="day-name">{{ names[i] }}</div>
                <div [class]="`day-value ${limits.purineLimit < values[0] ? 'red' : ''}`">{{ values[0].toFixed(0) }} mg
                  pürin</div>
                <div [class]="`day-value ${limits.sugarLimit < values[1] ? 'red' : ''}`">{{ values[1].toFixed(2) }} g
                  şeker</div>
                <div [class]="`day-value ${limits.kcalLimit < values[2] ? 'red' : ''}`">{{ values[2].toFixed(0) }} kcal
                </div>
              </div>
            </div>
          </ion-card-content>
        </ion-card>
        }
      </div>

      <h2 class="section-title">
        @let months =
        ["Ocak","Şubat","Mart","Nisan","Mayıs","Haziran","Temmuz","Ağustos","Eylül","Ekim","Kasım","Aralık"];
        {{ date.day.toString().padStart(2, "0") }} {{ months[date.month] }} Tüketimi
      </h2>

      <ion-list class="meals" lines="none" *ngIf="dataByDate.length > 0; else noData">
        <ion-item *ngFor="let entry of dataByDate" class="meal-item">
          @let consumedAt = createDateFrom(entry.timestamp);

          <ion-label>
            <h2>{{ entry.meal.name }}</h2>
            <p>Porsiyon: {{ entry.count }}</p>
            <p>
              Pürin: {{ (entry.meal.purine * entry.count).toFixed(0) }} mg
              Şeker: {{ (entry.meal.sugar * entry.count).toFixed(1) }} g
              Kalori: {{ (entry.meal.kcal * entry.count).toFixed(0) }} kcal
            </p>
          </ion-label>
          <div class="item-actions">
            <span class="meal-time">{{ consumedAt.getHours().toString().padStart(2, "0") }}:{{
              consumedAt.getMinutes().toString().padStart(2, "0") }}</span>

            <ion-button fill="clear" size="small" class="delete-button"
              (click)="deleteMeal(entry.meal.id, entry.timestamp)">
              <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
            </ion-button>
          </div>
        </ion-item>
      </ion-list>

      <ng-template #noData>
        <div class="empty-state">
          <ion-icon name="restaurant-outline"></ion-icon>
          <p>Bu tarihte kayıtlı yemek bulunmuyor.</p>
        </div>
      </ng-template>
    </div>
  </div>

  <ion-fab slot="fixed" vertical="bottom" horizontal="end">
    <ion-fab-button (click)="setOpen(true)">
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
  </ion-fab>

  <ion-modal [isOpen]="isModalOpen" (didDismiss)="setOpen(false)" [initialBreakpoint]="1" [breakpoints]="[0, 1]">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Yeni Yemek Ekle</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="setOpen(false)">Kapat</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content class="ion-padding">
        <ion-list>
          <ion-item>
            <ion-input placeholder="Yemek ara" (ionInput)="handleSearch($event)" [(ngModel)]="searchQuery" />
          </ion-item>

          <ion-item>
            <div forceOverscroll="false" class="search-results">
              <ion-list *ngIf="searchResults.length != 0">
                <ion-item *ngFor="let meal of searchResults;" (click)="selectSearchResult(meal)">
                  <p>{{ meal.name.split("(").slice(0, -1).join("(") }}</p>
                </ion-item>
              </ion-list>
            </div>
          </ion-item>

          <ion-item>
            <ion-select label="Kategori" placeholder="Kategori Seçin" [(ngModel)]="selectedCategory">
              <ion-select-option *ngFor="let category of getCategoryNames()" [value]="category">
                {{ category }}
              </ion-select-option>
            </ion-select>
          </ion-item>

          @if (selectedCategory) {
            <ion-item>
              <ion-select label="Yemek" placeholder="Yemek Seçin" (ionChange)="onSelectMeal($event)"
                [value]="currentMealEntry.meal?.id">
                <ion-select-option *ngFor="let meal of filterMeals()" [value]="meal.id">
                  {{ meal.name }}
                </ion-select-option>
              </ion-select>
            </ion-item>
          }

          <ion-item>
            <ion-input label="Porsiyon" label-placement="floating" type="number" inputmode="decimal" min="1"
              [(ngModel)]="currentMealEntry.count"></ion-input>
          </ion-item>

          <ion-item>
            <ion-input label="Tarih" label-placement="floating" type="date" [value]="currentDateString"
              (ionChange)="onDateChange($event)"></ion-input>
          </ion-item>

          <ion-item>
            <ion-input label="Saat" label-placement="floating" type="time" [value]="currentTimeString"
              (ionChange)="onTimeChange($event)"></ion-input>
          </ion-item>
        </ion-list>

        <ion-button expand="block" (click)="pushMealEntry()" class="ion-margin-top">
          <ion-icon name="add-circle-outline" slot="start"></ion-icon>
          Eklenecek Yemeklere Ekle
        </ion-button>

        <ion-card *ngIf="mealEntries.length > 0" class="ion-margin-top added-meals-card">
          <ion-card-header>
            <ion-card-title>Eklenecek Yemekler</ion-card-title>
          </ion-card-header>

          <ion-card-content>
            <ion-list lines="full">
              <ion-item *ngFor="let entry of mealEntries; let i = index">
                <ion-label>
                  <h2>{{ entry.meal?.name }}</h2>
                  <p>
                    {{ entry.count }} porsiyon 
                    {{ createDateFrom(entry.timestamp).toLocaleDateString('tr-TR') }}
                    {{ createDateFrom(entry.timestamp).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }) }}

                  <p class="meal-details">
                    Pürin: {{(entry.meal.purine * entry.count).toFixed(0)}}mg,
                    Şeker: {{(entry.meal.sugar * entry.count).toFixed(1)}}g,
                    Kalori: {{(entry.meal.kcal * entry.count).toFixed(0)}}kcal
                  </p>
                </ion-label>
                <ion-button fill="clear" color="danger" size="small" (click)="removeMealEntryFromList(i)">
                  <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
                </ion-button>
              </ion-item>
            </ion-list>
          </ion-card-content>
        </ion-card>

        <ion-button expand="block" (click)="addMeal()" class="ion-margin-top" [disabled]="mealEntries.length === 0">
          <ion-icon name="add-circle-outline" slot="start"></ion-icon>
          Seçilenleri Ekle
        </ion-button>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>