<div class="sticky-header" [class.visible]="showStickyHeader">
  <h1 class="sticky-title">NutriLog</h1>
  <div class="top-bar-actions">
    <ion-button fill="clear" (click)="goSettings()" class="icon-button">
      <ion-icon slot="icon-only" name="settings-outline"></ion-icon>
    </ion-button>

    <ion-button fill="clear" (click)="logout()" class="icon-button">
      <ion-icon slot="icon-only" name="log-out-outline"></ion-icon>
    </ion-button>
  </div>
</div>

<ion-content [scrollEvents]="true" (ionScroll)="onScroll($event)">
  <div *ngIf="authService.isLogged$ | async">
    @let user = (authService.user$ | async);

    <div *ngIf="(mealService.data$ | async) as data" class="page-container">
      <div *ngIf="(mealService.categories$ | async) as categories">
        @let meals = mealService.getAllMeals(categories);
        @let dataByDate = getEntriesOfDate(meals, data);

        <div class="top-bar">
          <h1 class="page-title">NutriLog</h1>
          <div class="top-bar-actions">
            <ion-button fill="clear" (click)="goSettings()" class="icon-button">
              <ion-icon slot="icon-only" name="settings-outline"></ion-icon>
            </ion-button>

            <ion-button fill="clear" (click)="logout()" class="icon-button">
              <ion-icon slot="icon-only" name="log-out-outline"></ion-icon>
            </ion-button>
          </div>
        </div>

        <ion-card class="control-panel">
          <ion-item lines="none">
            <ion-input type="date"
              [value]="getDateString(date.day, date.month + 1, date.year)"
              [max]="getDateString(today.getDate(), today.getMonth() + 1, today.getFullYear())"
              (ionChange)="onMainDateChange($event)">
            </ion-input>
          </ion-item>
        </ion-card>

        <div class="summary-grid">
          <app-card
            [dailyConsumption]="getTotal(DataType.PURINE, dataByDate)"
            [weeklyConsumption]="getWeeklyTotal(DataType.PURINE, data)"
            [title]="`${'HOME.CARDS.PURINE' | translate} (mg)`"
            [type]="DataType.PURINE"
            (changeChartType)="changeChartType($event)">
          </app-card>
          <app-chart *ngIf="chartType == DataType.PURINE" [data]="data" [date]="date" [type]="chartType"></app-chart>

          <app-card
            [dailyConsumption]="getTotal(DataType.SUGAR, dataByDate)"
            [weeklyConsumption]="getWeeklyTotal(DataType.SUGAR, data)"
            [title]="`${'HOME.CARDS.SUGAR' | translate} (g)`"
            [type]="DataType.SUGAR"
            [chartType]="chartType"
            (changeChartType)="changeChartType($event)"
            (data)="data"
            (date)="date">
          </app-card>
          <app-chart *ngIf="chartType == DataType.SUGAR" [data]="data" [date]="date" [type]="chartType"></app-chart>

          <app-card
            [dailyConsumption]="getTotal(DataType.KCAL, dataByDate)"
            [weeklyConsumption]="getWeeklyTotal(DataType.KCAL, data)"
            [title]="`${'HOME.CARDS.CALORIE' | translate} (kcal)`"
            [type]="DataType.KCAL"
            (changeChartType)="changeChartType($event)"
            (data)="data"
            (date)="date">
          </app-card>
          <app-chart *ngIf="chartType == DataType.KCAL" [data]="data" [date]="date" [type]="chartType"></app-chart>

          <app-water-card *ngIf="(waterConsumptionService.data$ | async) as waterConsumption"
            [user]="user"
            [dailyConsumption]="getDailyWater(waterConsumption)"
            [weeklyConsumption]="getWeeklyWater(waterConsumption)"
            (date)="date">
          </app-water-card>
        </div>

        <div class="conditional-content">
          @let weeklyData = getWeeklyNumberData(user, data);

          <ion-card class="summary-card weekly-summary">
            <ion-card-header>
              <ion-card-subtitle>{{ "HOME.DISTRIBUTION.TITLE" | translate }}</ion-card-subtitle>
            </ion-card-header>

            <ion-card-content>
              <div class="weekly-grid" *ngIf="user">
                @let limits = authService.getLimits(user);
                @let days = "HOME.DISTRIBUTION.DAYS" | translate;

                <div *ngFor="let values of weeklyData; index as i" class="day-item">
                  <div class="day-name">{{ days[i] }}</div>
                  <div [class]="`day-value ${limits.purineLimit < values[0] ? 'red' : ''}`">
                    {{ values[0].toFixed(0) }} mg {{ "HOME.DISTRIBUTION.PURINE" | translate }}
                  </div>

                  <div [class]="`day-value ${limits.sugarLimit < values[1] ? 'red' : ''}`">
                    {{ values[1].toFixed(2) }} g {{ "HOME.DISTRIBUTION.SUGAR" | translate }}
                  </div>

                  <div [class]="`day-value ${limits.kcalLimit < values[2] ? 'red' : ''}`">
                    {{ values[2].toFixed(0) }} kcal {{ "HOME.DISTRIBUTION.CALORIE" | translate }}
                  </div>
                </div>
              </div>
            </ion-card-content>
          </ion-card>
        </div>

        <h2 class="section-title">
          @let months = "HOME.CONSUMPTION.MONTHS" | translate;

          <span>{{ date.day.toString().padStart(2, "0") }} {{ months[date.month] }} {{ "HOME.CONSUMPTION.TITLE" | translate }} </span>

          <ion-button fill="clear" (click)="toggleInfo()" class="icon-button">
            <ion-icon slot="icon-only" name="information-circle-outline"></ion-icon>
          </ion-button>
        </h2>

        <ion-card class="info-card" *ngIf="isInfoVisible">
          <ion-card-content>
            <h3>üçΩÔ∏è {{ "HOME.INFORMATION.NUTRILOG.TITLE" | translate }}</h3>
            <p>{{ "HOME.INFORMATION.NUTRILOG.DESCRIPTION" | translate }}</p>

            <h3>üß† {{ "HOME.INFORMATION.PURINE.TITLE" | translate }}</h3>
            <p>{{ "HOME.INFORMATION.PURINE.DESCRIPTION" | translate }}</p>

            <h4>‚ö†Ô∏è {{ "HOME.INFORMATION.ATTENTION" | translate }}</h4>
            <p>{{ "HOME.INFORMATION.PURINE.EXCESSIVE" | translate }}:</p>

            <ul>
              @let purineRisks = "HOME.INFORMATION.PURINE.RISKS" | translate;
              <li *ngFor="let risk of purineRisks">{{ risk }}</li>
            </ul>

            <h4>‚úÖ {{ "HOME.INFORMATION.SUGGESTIONS" | translate }}</h4>
            <ul>
              @let purineSuggestions = "HOME.INFORMATION.PURINE.SUGGESTIONS" | translate;
              <li *ngFor="let suggestion of purineSuggestions">{{ suggestion }}</li>
            </ul>

            <hr />

            <h3>üç≠ {{ "HOME.INFORMATION.SUGAR.TITLE" | translate }}</h3>
            <p>{{ "HOME.INFORMATION.SUGAR.DESCRIPTION" | translate }}</p>

            <h4>‚ö†Ô∏è {{ "HOME.INFORMATION.ATTENTION" | translate }}</h4>
            <p>{{ "HOME.INFORMATION.SUGAR.EXCESSIVE" | translate }}:</p>

            <ul>
              @let sugarRisks = "HOME.INFORMATION.SUGAR.RISKS" | translate;
              <li *ngFor="let risk of sugarRisks">{{ risk }}</li>
            </ul>

            <h4>‚úÖ {{ "HOME.INFORMATION.SUGGESTIONS" | translate }}</h4>
            <ul>
              @let sugarSuggestions = "HOME.INFORMATION.SUGAR.RISKS" | translate;
              <li *ngFor="let suggestion of sugarSuggestions">{{ suggestion }}</li>
            </ul>

            <hr />

            <h3>üî• {{ "HOME.INFORMATION.CALORIE.TITLE" | translate }}</h3>
            <p>{{ "HOME.INFORMATION.CALORIE.DESCRIPTION" | translate }}</p>

            @let calorieRisks = "HOME.INFORMATION.CALORIE.RISKS" | translate;
            <h4>‚ö†Ô∏è {{ "HOME.INFORMATION.ATTENTION" | translate }}</h4>
            <p>{{ "HOME.INFORMATION.CALORIE.EXCESSIVE" | translate }}:</p>
            <ul>
              <li>{{ calorieRisks[0] }}</li>
              <li>{{ calorieRisks[1] }}</li>
              <li>{{ calorieRisks[2] }}</li>
            </ul>

            <p>{{ "HOME.INFORMATION.CALORIE.EXCESSIVE" | translate }}:</p>
            <ul>
              <li>{{ calorieRisks[3] }}</li>
            </ul>

            <h4>‚úÖ {{ "HOME.INFORMATION.SUGGESTIONS" | translate }}</h4>
            <ul>
              @let calorieSuggestions = "HOME.INFORMATION.CALORIE.SUGGESTIONS" | translate;
              <li *ngFor="let suggestion of calorieSuggestions">{{ suggestion }}</li>
            </ul>
          </ion-card-content>
        </ion-card>

        <ion-list class="meals" lines="none" *ngIf="dataByDate.length > 0; else noData">
          <ion-item *ngFor="let entry of dataByDate" class="meal-item">
            @let consumedAt = createDateFrom(entry.timestamp);

            <ion-label>
              <h2>{{ entry.meal.name }}</h2>
              <p>{{ "HOME.CONSUMPTION.PORTION" | translate }}: {{ entry.count }}</p>
              <p>
                {{ "HOME.CONSUMPTION.PURINE" | translate }}: {{ (entry.meal.purine * entry.count).toFixed(0) }} mg <br />
                {{ "HOME.CONSUMPTION.SUGAR" | translate }}: {{ (entry.meal.sugar * entry.count).toFixed(1) }} g <br />
                {{ "HOME.CONSUMPTION.CALORIE" | translate }}: {{ (entry.meal.kcal * entry.count).toFixed(0) }} kcal
              </p>
            </ion-label>
            <div class="item-actions">
              <span class="meal-time">{{ consumedAt.getHours().toString().padStart(2, "0") }}:{{
                consumedAt.getMinutes().toString().padStart(2, "0") }}</span>

              <ion-button fill="clear" size="small" class="delete-button"
                (click)="deleteMeal(entry.meal.id, entry.timestamp)">
                <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
              </ion-button>
            </div>
          </ion-item>
        </ion-list>

        <ng-template #noData>
          <div class="empty-state">
            <ion-icon name="restaurant-outline"></ion-icon>
            <p>{{ "HOME.CONSUMPTION.NO_FOOD" | translate }}.</p>
          </div>
        </ng-template>
      </div>
    </div>
  </div>

  <ion-fab slot="fixed" vertical="bottom" horizontal="end">
    <ion-fab-button (click)="setOpen(true)">
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
  </ion-fab>

  <ion-modal [isOpen]="isModalOpen" (didDismiss)="setOpen(false)" [initialBreakpoint]="1" [breakpoints]="[0, 1]" *ngIf="(mealService.categories$ | async) as categories">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Yeni Yemek Ekle</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="setOpen(false)">Kapat</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content class="ion-padding">
        <ng-container *ngIf="isCreatingNewMeal">
          <ion-list>
             <ion-item lines="none">
                <ion-label>
                  <h2>Yeni √ñzel Yemek Olu≈ütur</h2>
                  <p>1 porsiyon i√ßin besin deƒüerlerini girin.</p>
                </ion-label>
                <ion-button slot="end" fill="clear" (click)="toggleCreateNewMealView(false)">
                    Vazge√ß
                </ion-button>
            </ion-item>

            <ion-item>
                <ion-input label="Yemek Adƒ±" label-placement="floating" [(ngModel)]="newCustomMeal.name" required></ion-input>
            </ion-item>
            <ion-item>
                <ion-input label="P√ºrin (mg / porsiyon)" label-placement="floating" type="number" [(ngModel)]="newCustomMeal.purine" required></ion-input>
            </ion-item>
             <ion-item>
                <ion-input label="≈ûeker (g / porsiyon)" label-placement="floating" type="number" [(ngModel)]="newCustomMeal.sugar" required></ion-input>
            </ion-item>
            <ion-item>
                <ion-input label="Kalori (kcal / porsiyon)" label-placement="floating" type="number" [(ngModel)]="newCustomMeal.kcal" required></ion-input>
            </ion-item>
            <ion-button expand="block" (click)="createAndSelectCustomMeal()" class="ion-margin-top">
                Olu≈ütur ve Se√ß
            </ion-button>
        </ion-list>
        </ng-container>

        <ng-container *ngIf="!isCreatingNewMeal">
          <ion-list>
            <ion-item>
              <ion-input #searchInput placeholder="Yemek ara" (ionInput)="handleSearch($event)" [(ngModel)]="searchQuery"></ion-input>
              <ion-button slot="end" fill="clear" (click)="toggleCreateNewMealView(true)" title="Yeni √∂zel yemek olu≈ütur">
                <ion-icon slot="icon-only" name="add-circle-outline"></ion-icon>
              </ion-button>
            </ion-item>

            <ion-item *ngIf="searchResults.length != 0">
              <div forceOverscroll="false" class="search-results">
                <ion-list>
                  <ion-item *ngFor="let meal of searchResults;" (click)="selectSearchResult(meal)">
                    <p>{{ meal.name }}</p>
                  </ion-item>
                </ion-list>
              </div>
            </ion-item>
            
            <ion-item>
              <ion-select label="Kategori" placeholder="Kategori Se√ßin" [(ngModel)]="selectedCategory">
                <ion-select-option *ngFor="let category of getCategoryNames(categories)" [value]="category">
                  {{ category }}
                </ion-select-option>
              </ion-select>
            </ion-item>

            <!--<ion-item *ngIf="selectedCategory">
              <ion-select label="Yemek" placeholder="Yemek Se√ßin" (ionChange)="onSelectMeal($event)"
                [value]="currentMealEntry.meal?.id">
                <ion-select-option *ngFor="let meal of filterMeals()" [value]="meal.id">
                  {{ meal.name }}
                </ion-select-option>
              </ion-select>
            </ion-item>-->
          </ion-list>
        </ng-container>
        
        <ion-list>
          <ion-item>
            <ion-input label="Porsiyon" label-placement="floating" type="number" inputmode="decimal" min="1"
              [(ngModel)]="currentMealEntry.count"></ion-input>
          </ion-item>

          <ion-item *ngIf="currentMealEntry.meal">
            <p>{{ currentMealEntry.count }} porsiyon i√ßin</p>
            <ul>
              <li>P√ºrin: {{ currentMealEntry.count * currentMealEntry.meal.purine }} mg</li>
              <li>≈ûeker: {{ currentMealEntry.count * currentMealEntry.meal.sugar }} g</li>
              <li>Kalori: {{ currentMealEntry.count * currentMealEntry.meal.kcal }}</li>
            </ul>
          </ion-item>

          <ion-item>
            <ion-input label="Tarih" label-placement="floating" type="date" [value]="currentDateString"
              (ionChange)="onDateChange($event)"></ion-input>
          </ion-item>

          <ion-item>
            <ion-input label="Saat" label-placement="floating" type="time" [value]="currentTimeString"
              (ionChange)="onTimeChange($event)"></ion-input>
          </ion-item>
        </ion-list>

        <ion-button expand="block" (click)="pushMealEntry()" class="ion-margin-top">
          <ion-icon name="add-circle-outline" slot="start"></ion-icon>
          Eklenecek Yemeklere Ekle
        </ion-button>

        <ion-card *ngIf="mealEntries.length > 0" class="ion-margin-top added-meals-card">
          <ion-card-header>
            <ion-card-title>Eklenecek Yemekler</ion-card-title>
          </ion-card-header>

          <ion-card-content>
            <ion-list lines="full">
              <ion-item *ngFor="let entry of mealEntries; let i = index">
                <ion-label>
                  <h2>{{ entry.meal?.name }}</h2>
                  <p>
                    {{ entry.count }} porsiyon 
                    {{ createDateFrom(entry.timestamp).toLocaleDateString('tr-TR') }}
                    {{ createDateFrom(entry.timestamp).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }) }}

                  <p class="meal-details">
                    P√ºrin: {{(entry.meal.purine * entry.count).toFixed(0)}}mg, <br>
                    ≈ûeker: {{(entry.meal.sugar * entry.count).toFixed(1)}}g, <br>
                    Kalori: {{(entry.meal.kcal * entry.count).toFixed(0)}}kcal
                  </p>
                </ion-label>
                <ion-button fill="clear" color="danger" size="small" (click)="removeMealEntryFromList(i)">
                  <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
                </ion-button>
              </ion-item>
            </ion-list>
          </ion-card-content>
        </ion-card>

        <ion-button expand="block" (click)="addMeal()" class="ion-margin-top bottom-button" [disabled]="mealEntries.length === 0">
          <ion-icon name="add-circle-outline" slot="start"></ion-icon>
          Se√ßilenleri Ekle
        </ion-button>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>