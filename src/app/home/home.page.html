<ion-content>
  <div *ngIf="authService.isLogged">
    <div *ngIf="(mealService.data$ | async) as data" class="page-container">
      @let dataByDate = getEntriesOfDate(data);

      <div class="top-bar">
        <h1 class="page-title">Pürin Takibi</h1>
        <div class="top-bar-actions">
        <ion-button fill="clear" (click)="goSettings()" class="icon-button">
          <ion-icon slot="icon-only" name="settings-outline"></ion-icon>
        </ion-button>

        <ion-button fill="clear" (click)="logout()" class="icon-button">
          <ion-icon slot="icon-only" name="log-out-outline"></ion-icon>
        </ion-button>
      </div>
      </div>

      <ion-card class="control-panel">
        <ion-item lines="none">
          <ion-input label="Tarih" label-placement="floating" type="date"
            [value]="getDateString(date.day, date.month + 1, date.year)"
            [max]="getDateString(today.getDate(), today.getMonth() + 1, today.getFullYear())"
            (ionChange)="onMainDateChange($event)">
          </ion-input>
        </ion-item>
        <ion-item lines="none">
          <ion-toggle [(ngModel)]="isGraphMode" label-placement="start">Haftalık Grafik</ion-toggle>
        </ion-item>
      </ion-card>

      <div class="summary-grid">
        <ion-card class="summary-card">
          <ion-card-header>
            <ion-card-subtitle>Günlük Toplam Pürin</ion-card-subtitle>
            <ion-card-title>{{ getTotalPurine(dataByDate).toFixed(0) }} mg</ion-card-title>
          </ion-card-header>

          <ion-card-content>
            <p>{{ getComment(getTotalPurine(dataByDate)) }}</p>
          </ion-card-content>
        </ion-card>

        <ion-card class="summary-card">
          <ion-card-header>
            <ion-card-subtitle>Bu Haftanın Toplamı</ion-card-subtitle>
            <ion-card-title>{{ getWeeklyPurine(data).toFixed(0) }} mg</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <p>{{ getWeeklyComment(getWeeklyPurine(data)) }}</p>
          </ion-card-content>
        </ion-card>
      </div>

      <div class="conditional-content">
        @if (isGraphMode) {
          <app-chart [data]="data" [date]="date"></app-chart>
        } @else {
          @let weeklyData = getWeeklyNumberData(data);
          @let names = ["Pazartesi", "Salı", "Çarşamba", "Perşembe", "Cuma", "Cumartesi", "Pazar"];

          <ion-card class="summary-card weekly-summary">
            <ion-card-header>
              <ion-card-subtitle>Haftalık Pürin Dağılımı</ion-card-subtitle>
            </ion-card-header>

            <ion-card-content>
              <div class="weekly-grid">
                <div *ngFor="let values of weeklyData; index as i" class="day-item">
                  <div class="day-name">{{ names[i] }}</div>
                  <div class="day-value">{{ values[0].toFixed(0) }} mg pürin</div>
                  <div class="day-value">{{ values[1].toFixed(2) }} g şeker</div>
                  <div class="day-value">{{ values[2].toFixed(0) }} kcal</div>
                </div>
              </div>
            </ion-card-content>
          </ion-card>
        }
      </div>

      <h2 class="section-title">
        @let months = ["Ocak","Şubat","Mart","Nisan","Mayıs","Haziran","Temmuz","Ağustos","Eylül","Ekim","Kasım","Aralık"];
        {{ date.day.toString().padStart(2, "0") }} {{ months[date.month] }} Raporu
      </h2>

      <ion-list lines="none" *ngIf="dataByDate.length > 0; else noData">
        <ion-item *ngFor="let entry of dataByDate" class="meal-item">
          @let consumedAt = createDateFrom(entry.timestamp);
          <ion-label>
            <h2>{{ entry.meal.name }}</h2>
            <p>
              {{ entry.count }} porsiyon ·
              Pürin: {{ (entry.meal.purine * entry.count).toFixed(0) }} mg
            </p>

            <p>
              Kalori: {{ (entry.meal.kcal * entry.count).toFixed(0) }} kcal ·
              Şeker: {{ (entry.meal.sugar * entry.count).toFixed(1) }} g
            </p>
          </ion-label>

          <div class="item-actions">
            <span class="meal-time">
              {{ consumedAt.getHours().toString().padStart(2, "0") }}:{{ consumedAt.getMinutes().toString().padStart(2, "0") }}
            </span>

            <ion-button fill="clear" size="small" class="delete-button" (click)="deleteMeal(entry.meal.id, entry.timestamp)">
              <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
            </ion-button>
          </div>
        </ion-item>
      </ion-list>

      <ng-template #noData>
        <div class="empty-state">
          <ion-icon name="restaurant-outline"></ion-icon>
          <p>Bu tarihte kayıtlı yemek bulunmuyor.</p>
        </div>
      </ng-template>
    </div>
  </div>



  <ion-fab slot="fixed" vertical="bottom" horizontal="end">
    <ion-fab-button (click)="setOpen(true)">
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
  </ion-fab>


  <ion-modal [isOpen]="isModalOpen" (didDismiss)="setOpen(false)" [initialBreakpoint]="1" [breakpoints]="[0, 1]">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Yeni Yemek Ekle</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="setOpen(false)">Kapat</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content class="ion-padding">
        <ion-item>
          @let categoryNames = getCategoryNames();

          <ion-select label="Kategori" placeholder="Kategori Seçin" [(ngModel)]="selectedCategory">
            <ion-select-option *ngFor="let category of categoryNames" [value]="category">
              {{ category }}
            </ion-select-option>
          </ion-select>
        </ion-item>

        @if (selectedCategory) {
          @let filteredMeals = filterMeals();

          <ion-item *ngIf="filteredMeals.length > 0">
            <ion-select label="Yemek" placeholder="Yemek Seçin" (ionChange)="onSelectMeal($event)">
              <ion-select-option *ngFor="let meal of filteredMeals" [value]="meal.id">
                {{ meal.name }}
              </ion-select-option>
            </ion-select>
          </ion-item>
        }

        <ion-item>
          <ion-input
            label="Porsiyon"
            label-placement="floating"
            type="number"
            inputmode="numeric"
            [(ngModel)]="currentMealEntry.count"
            min="1">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-input
            label="Tarih"
            label-placement="floating"
            type="date"
            [value]="currentDateString"
            (ionChange)="onDateChange($event)">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-input
            label="Saat"
            label-placement="floating"
            type="time"
            [value]="currentTimeString"
            (ionChange)="onTimeChange($event)">
          </ion-input>
        </ion-item>

        <ion-button expand="block" (click)="addMeal()" class="ion-margin-top"
          [disabled]="!currentMealEntry.meal || currentMealEntry.count === null || !currentMealEntry.timestamp">
          <ion-icon name="add-circle-outline" slot="start"></ion-icon>
          Ekle
        </ion-button>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>